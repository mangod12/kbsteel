<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>KumarBrothers â€” Customer Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <style>
      .stage { padding: 10px 20px; border-radius: 5px; text-align: center; font-weight: bold; }
      .stage.pending { background: #e9ecef; color: #6c757d; }
      .stage.in-progress { background: #fff3cd; color: #856404; }
      .stage.completed { background: #d4edda; color: #155724; }
      .item-card { border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 10px; }
      .item-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
      .deduction-badge { font-size: 0.7rem; }
    </style>
  </head>
  <body>
    <nav class="kb-navbar d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <div class="navbar-brand">KumarBrothers</div>
        <div class="d-none d-lg-flex">
          <a class="nav-link text-white ms-3" href="index.html">Dashboard</a>
          <a class="nav-link text-white ms-3" href="raw_material.html">Inventory</a>
          <a class="nav-link text-white ms-3" href="customers.html">Customers</a>
          <a class="nav-link text-white ms-3" href="tracking_v2.html">Tracking</a>
          <a class="nav-link text-white ms-3" href="queries.html">Queries</a>
          <a class="nav-link text-white ms-3" href="instructions.html">Instructions</a>
          <a class="nav-link text-white ms-3 kb-logout" href="#">Logout</a>
        </div>
      </div>
      <div class="d-flex align-items-center gap-3">
        <div class="small-muted">Role:</div>
        <div id="current-role" class="role-badge">Loading...</div>
      </div>
    </nav>

    <div class="container-fluid main-container">
      <div class="mb-3 d-flex justify-content-between align-items-center">
        <div>
          <h3 id="custName">Customer Name</h3>
          <div class="small-muted" id="custProject">Project Name</div>
          <div class="mt-1">Current Stage: <strong id="custStage">-</strong></div>
        </div>
        <div>
          <a href="customers.html" class="btn btn-kb">Back to Customers</a>
          <button class="btn btn-success ms-2" onclick="location.reload()">ðŸ”„ Refresh</button>
        </div>
      </div>

      <!-- Stage Tracker Overview -->
      <div class="card p-4 mb-4">
        <h6>Production Stages (Fabrication â†’ Painting â†’ Dispatch)</h6>
        <div class="d-flex justify-content-between mt-3" id="stageTracker">
          <div class="stage pending" data-stage="Fabrication">Fabrication</div>
          <div class="stage pending" data-stage="Painting">Painting</div>
          <div class="stage pending" data-stage="Dispatch">Dispatch</div>
        </div>
        <div class="mt-2 small text-muted">
          <strong>Note:</strong> When Fabrication is completed, raw materials are automatically deducted from inventory.
        </div>
      </div>

      <!-- Production Items List -->
      <div class="card p-4 mb-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h6 class="mb-0">Production Items</h6>
          <input type="text" class="form-control w-25" id="itemSearch" placeholder="Search items...">
        </div>
        <div id="productionItemsList">
          <div class="text-muted">Loading items...</div>
        </div>
      </div>

      <!-- Material Usage Summary -->
      <div class="card p-4 mb-4">
        <h6>Material Usage Summary</h6>
        <div id="usageLog">
          <div class="text-muted">Loading usage log...</div>
        </div>
      </div>

      <!-- Stage History -->
      <div class="card p-4 mb-4">
        <h6>Stage History</h6>
        <div id="stageHistory">
          <div class="text-muted">Loading history...</div>
        </div>
      </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/main.js"></script>
    <script>
      const API_BASE = (typeof KBConfig !== 'undefined') ? KBConfig.API_BASE : 'http://127.0.0.1:8000';
      const trackingApiBase = `${API_BASE}/tracking`;
      let currentCustomerId = null;
      let currentItems = [];

      function escapeHtml(s) { 
        return String(s || '').replace(/[&<>"']/g, c => ({
          '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[c])); 
      }

      function statusBadge(status) {
        const s = String(status || 'pending').toLowerCase();
        if(s === 'completed') return '<span class="badge bg-success">Completed</span>';
        if(s === 'in_progress') return '<span class="badge bg-warning text-dark">In Progress</span>';
        return '<span class="badge bg-secondary">Pending</span>';
      }

      async function loadCustomerDetails() {
        const params = new URLSearchParams(window.location.search);
        currentCustomerId = params.get('id');
        if(!currentCustomerId) {
          document.getElementById('custName').textContent = 'Customer not found';
          return;
        }

        try {
          const res = await fetch(`${trackingApiBase}/customers/${currentCustomerId}`);
          if(!res.ok) throw new Error('Customer not found');
          const c = await res.json();

          document.getElementById('custName').textContent = c.name || 'Unknown';
          document.getElementById('custProject').textContent = c.project || '';
          document.getElementById('custStage').textContent = c.current_stage || 'Pending';

          // Update stage tracker visualization
          const stages = ['Fabrication', 'Painting', 'Dispatch'];
          const curStageIdx = stages.findIndex(s => s === c.current_stage);
          
          document.querySelectorAll('#stageTracker .stage').forEach((el, idx) => {
            el.classList.remove('completed', 'in-progress', 'pending');
            if(curStageIdx >= 0) {
              if(idx < curStageIdx) el.classList.add('completed');
              else if(idx === curStageIdx) el.classList.add('in-progress');
              else el.classList.add('pending');
            } else {
              el.classList.add('pending');
            }
          });

          // Load and display production items
          currentItems = c.production_items || [];
          renderProductionItems(currentItems);

          // Material usage log
          const usageLog = document.getElementById('usageLog');
          if(c.material_usage && c.material_usage.length > 0) {
            usageLog.innerHTML = c.material_usage.map(u => `
              <div class="mb-2 p-2 bg-light rounded">
                <strong>${escapeHtml(u.name)}</strong> - ${u.qty} ${escapeHtml(u.unit || '')}
                <br><small class="text-muted">${new Date(u.ts).toLocaleString()} â€¢ ${escapeHtml(u.by || 'System')}</small>
              </div>
            `).join('');
          } else {
            usageLog.innerHTML = '<div class="text-muted">No material usage recorded yet.</div>';
          }

          // Stage history
          const historyEl = document.getElementById('stageHistory');
          if(c.stage_history && c.stage_history.length > 0) {
            historyEl.innerHTML = c.stage_history.map(h => `
              <div class="mb-2">
                <strong>${escapeHtml(h.stage)}</strong> - ${h.status}
                <br><small class="text-muted">
                  ${h.started_at ? 'Started: ' + new Date(h.started_at).toLocaleString() : ''}
                  ${h.completed_at ? ' | Completed: ' + new Date(h.completed_at).toLocaleString() : ''}
                </small>
              </div>
            `).join('');
          } else {
            historyEl.innerHTML = '<div class="text-muted">No stage history yet.</div>';
          }

        } catch(err) {
          console.error('Load error:', err);
          document.getElementById('custName').textContent = 'Error loading customer';
        }
      }

      function renderProductionItems(items) {
        const container = document.getElementById('productionItemsList');
        
        if(!items || items.length === 0) {
          container.innerHTML = '<div class="text-muted">No production items. Upload an Excel file to start tracking.</div>';
          return;
        }

        container.innerHTML = items.map(item => {
          // Determine item's current stage
          const stages = item.stages || [];
          const stageMap = {};
          stages.forEach(s => { stageMap[s.stage] = s.status; });
          
          const fabStatus = stageMap['fabrication'] || 'pending';
          const paintStatus = stageMap['painting'] || 'pending';
          const dispStatus = stageMap['dispatch'] || 'pending';
          
          // Current stage for this item
          let itemStage = 'Fabrication';
          if(dispStatus === 'completed') itemStage = 'Completed';
          else if(dispStatus === 'in_progress' || paintStatus === 'completed') itemStage = 'Dispatch';
          else if(paintStatus === 'in_progress' || fabStatus === 'completed') itemStage = 'Painting';
          
          const deductedBadge = item.fabrication_deducted 
            ? '<span class="badge bg-info deduction-badge">âœ“ Materials Deducted</span>' 
            : '';

          return `
            <div class="item-card">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <strong>${escapeHtml(item.item_name)}</strong> 
                  <small class="text-muted">(${escapeHtml(item.item_code)})</small>
                  ${deductedBadge}
                  <br>
                  <small>Section: ${escapeHtml(item.section || '-')} | Qty: ${item.quantity || 1} ${escapeHtml(item.unit || '')}</small>
                </div>
                <div class="text-end">
                  <div class="mb-1">Current: <strong>${itemStage}</strong></div>
                  ${fabStatus !== 'completed' ? `
                    <button class="btn btn-sm btn-outline-warning me-1" onclick="startStage(${item.id}, 'fabrication')">Start Fab</button>
                    <button class="btn btn-sm btn-warning" onclick="completeStage(${item.id}, 'fabrication')">Complete Fab</button>
                  ` : paintStatus !== 'completed' ? `
                    <button class="btn btn-sm btn-outline-info me-1" onclick="startStage(${item.id}, 'painting')">Start Paint</button>
                    <button class="btn btn-sm btn-info" onclick="completeStage(${item.id}, 'painting')">Complete Paint</button>
                  ` : dispStatus !== 'completed' ? `
                    <button class="btn btn-sm btn-outline-success me-1" onclick="startStage(${item.id}, 'dispatch')">Start Dispatch</button>
                    <button class="btn btn-sm btn-success" onclick="completeStage(${item.id}, 'dispatch')">Complete Dispatch</button>
                  ` : '<span class="badge bg-success">âœ“ Fully Completed</span>'}
                </div>
              </div>
              <div class="mt-2">
                <small>
                  Fab: ${statusBadge(fabStatus)} | 
                  Paint: ${statusBadge(paintStatus)} | 
                  Dispatch: ${statusBadge(dispStatus)}
                </small>
              </div>
            </div>
          `;
        }).join('');
      }

      async function startStage(itemId, stage) {
        try {
          const res = await fetch(`${trackingApiBase}/start-stage`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ production_item_id: itemId, stage: stage }),
          });
          if(!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'Failed to start stage');
          }
          loadCustomerDetails(); // Refresh
        } catch(err) {
          alert(err.message);
        }
      }

      async function completeStage(itemId, stage) {
        const msg = stage === 'fabrication' 
          ? 'Completing Fabrication will automatically deduct raw materials from inventory. Continue?' 
          : `Complete ${stage} stage?`;
        
        if(!confirm(msg)) return;

        try {
          const res = await fetch(`${trackingApiBase}/complete-stage`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ production_item_id: itemId, stage: stage }),
          });
          if(!res.ok) {
            const err = await res.json();
            throw new Error(err.detail || 'Failed to complete stage');
          }
          
          if(stage === 'fabrication') {
            alert('âœ“ Stage completed and materials deducted from inventory!');
          }
          
          loadCustomerDetails(); // Refresh
        } catch(err) {
          alert(err.message);
        }
      }

      // Search filter
      document.getElementById('itemSearch').addEventListener('input', function() {
        const term = this.value.toLowerCase();
        const filtered = currentItems.filter(item => 
          (item.item_name || '').toLowerCase().includes(term) ||
          (item.item_code || '').toLowerCase().includes(term) ||
          (item.section || '').toLowerCase().includes(term)
        );
        renderProductionItems(filtered);
      });

      // Initial load
      loadCustomerDetails();

      // NOTE: Auto-refresh REMOVED - use Refresh button to avoid UI interference
    </script>
  </body>
</html>