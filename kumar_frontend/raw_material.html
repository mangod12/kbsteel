<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>KumarBrothers â€” Raw Material</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <style>
      .low-stock { background-color: #f8d7da !important; }
      .medium-stock { background-color: #fff3cd !important; }
    </style>
  </head>
  <body>
    <nav class="kb-navbar d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <div class="navbar-brand">KumarBrothers</div>
          <div class="d-none d-lg-flex">
          <a class="nav-link text-white ms-3" href="index.html">Dashboard</a>
          <a class="nav-link text-white ms-3" href="raw_material.html">Inventory</a>
          <a class="nav-link text-white ms-3" href="grn.html">GRN</a>
          <a class="nav-link text-white ms-3" href="dispatch.html">Dispatch</a>
          <a class="nav-link text-white ms-3" href="customers.html">Customers</a>
          <a class="nav-link text-white ms-3" href="tracking_v2.html">Tracking</a>
          <a class="nav-link text-white ms-3" href="settings.html">Settings</a>
          <a class="nav-link text-white ms-3 kb-logout" href="#">Logout</a>
        </div>
      </div>
      <div class="d-flex align-items-center gap-3">
        <div class="small-muted">Role:</div>
        <div id="current-role" class="role-badge">Loading...</div>
      </div>
    </nav>

    <div class="container-fluid main-container">
      <!-- Page Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="fw-bold mb-0">Raw Materials Inventory</h2>
          <small class="text-muted">Raw material availability and usage tracking. Materials auto-deduct when fabrication completes.</small>
        </div>
        <div>
          <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addMaterialModal">+ Add Material</button>
          <button class="btn btn-outline-primary ms-2" onclick="refreshInventory()">ðŸ”„ Refresh</button>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card p-3">
            <small class="text-muted">Total Materials</small>
            <h4 id="statTotalMaterials">0</h4>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card p-3">
            <small class="text-muted">Total Stock Value</small>
            <h4 id="statTotalValue">0</h4>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card p-3">
            <small class="text-muted">Low Stock Items</small>
            <h4 id="statLowStock" class="text-danger">0</h4>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card p-3">
            <small class="text-muted">Last Updated</small>
            <h4 id="statLastUpdate">-</h4>
          </div>
        </div>
      </div>

      <!-- Search & Filter Bar -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
          <div class="row g-3 align-items-end">

            <div class="col-md-3">
              <label class="form-label">Search Material</label>
              <input type="text" class="form-control" id="fName" placeholder="Name / Code / Section">
            </div>

            <div class="col-md-2">
              <label class="form-label">Category</label>
              <select class="form-select" id="fCategory">
                <option value="">All</option>
                <option value="steel">Steel</option>
                <option value="pipe">Pipe</option>
                <option value="sheet">Sheet</option>
              </select>
            </div>

            <div class="col-md-2">
              <label class="form-label">Min Quantity</label>
              <input type="number" class="form-control" id="fQtyMin">
            </div>

            <div class="col-md-2">
              <label class="form-label">Max Quantity</label>
              <input type="number" class="form-control" id="fQtyMax">
            </div>

            <div class="col-md-2">
              <label class="form-label">Unit</label>
              <select class="form-select" id="fUnit">
                <option value="">All</option>
                <option value="kg">KG</option>
                <option value="pcs">PCS</option>
                <option value="meter">Meter</option>
              </select>
            </div>

            <div class="col-md-1 d-grid">
              <button class="btn btn-primary" id="filterSearchBtn" type="button">Search</button>
            </div>

          </div>
        </div>
      </div>

      <!-- Inventory Table Card -->
      <div class="card shadow-sm border-0 mb-3">
        <div class="card-body">
          <h5 class="fw-semibold mb-3">Material List</h5>

          <div class="table-responsive">
            <table id="inventoryTable" class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th>Material Name</th>
                  <th>Unit</th>
                  <th>Total Stock</th>
                  <th>Used</th>
                  <th>Available</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="inventoryTableBody">
                <!-- Rows populated by JS -->
              </tbody>
            </table>
          </div>

        </div>
      </div>

      <!-- Empty / No Results State -->
      <div class="text-center text-muted py-4 d-none" id="noInventoryResults">No materials found matching the criteria.</div>

    </div>

    <!-- Add Material Modal -->
    <div class="modal fade" id="addMaterialModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add New Raw Material</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Material Name *</label>
              <input type="text" class="form-control" id="newName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Unit</label>
              <select class="form-select" id="newUnit">
                <option value="kg">KG</option>
                <option value="pcs">PCS</option>
                <option value="meter">Meter</option>
                <option value="ton">Ton</option>
                <option value="liter">Liter</option>
              </select>
            </div>
            <div class="row">
              <div class="col-6 mb-3">
                <label class="form-label">Total Quantity *</label>
                <input type="number" step="0.01" class="form-control" id="newTotal" value="0">
              </div>
              <div class="col-6 mb-3">
                <label class="form-label">Already Used</label>
                <input type="number" step="0.01" class="form-control" id="newUsed" value="0">
              </div>
            </div>
            <div class="alert alert-info small">
              <strong>Note:</strong> Once added, this material will be visible on the dashboard and all user accounts immediately.
              Materials are automatically deducted when fabrication stage is completed.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="addItemBtn">Add Material</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/main.js"></script>
    <script>
      const API_BASE = (typeof KBConfig !== 'undefined') ? KBConfig.API_BASE : 'http://127.0.0.1:8000';
      const inventoryApiBase = `${API_BASE}/inventory`;

      function escapeHtml(s) { 
        return String(s || '').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); 
      }

      async function refreshInventory() {
        try {
          const params = new URLSearchParams();
          const name = document.getElementById('fName').value.trim();
          const category = document.getElementById('fCategory').value;
          const unit = document.getElementById('fUnit').value;
          const qtyMin = document.getElementById('fQtyMin').value;
          const qtyMax = document.getElementById('fQtyMax').value;

          if(name) params.append('material_name', name);
          if(category) params.append('category', category);
          if(unit) params.append('unit', unit);
          if(qtyMin) params.append('quantity_min', qtyMin);
          if(qtyMax) params.append('quantity_max', qtyMax);

          const url = params.toString() ? `${inventoryApiBase}?${params}` : inventoryApiBase;
          const res = await fetch(url);
          if(!res.ok) throw new Error('Failed to fetch');
          const items = await res.json();

          renderInventory(items);
          updateStats(items);
        } catch(err) {
          console.error('Inventory fetch error:', err);
          renderInventory([]);
        }
      }

      function renderInventory(items) {
        const tbody = document.getElementById('inventoryTableBody');
        const emptyEl = document.getElementById('noInventoryResults');
        tbody.innerHTML = '';

        if(!items || items.length === 0) {
          emptyEl.classList.remove('d-none');
          return;
        }
        emptyEl.classList.add('d-none');

        items.forEach(item => {
          const remaining = (item.total || 0) - (item.used || 0);
          const pct = item.total > 0 ? (remaining / item.total * 100) : 0;
          
          let statusClass = 'bg-success';
          let statusText = 'OK';
          let rowClass = '';
          
          if(pct < 15) { 
            statusClass = 'bg-danger'; 
            statusText = 'Low'; 
            rowClass = 'low-stock';
          } else if(pct < 30) { 
            statusClass = 'bg-warning text-dark'; 
            statusText = 'Medium';
            rowClass = 'medium-stock';
          }

          const tr = document.createElement('tr');
          tr.className = rowClass;
          tr.dataset.id = item.id;
          tr.innerHTML = `
            <td class="inv-name">${escapeHtml(item.name)}</td>
            <td class="inv-unit">${escapeHtml(item.unit || '-')}</td>
            <td class="inv-total">${Number(item.total).toFixed(2)}</td>
            <td class="inv-used">${Number(item.used).toFixed(2)}</td>
            <td class="remaining-qty"><strong>${remaining.toFixed(2)}</strong></td>
            <td><span class="badge ${statusClass}">${statusText}</span></td>
            <td>
              <button class="btn btn-sm btn-outline-primary edit-btn">Edit</button>
              <button class="btn btn-sm btn-outline-danger delete-btn">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);

          // Attach event handlers
          tr.querySelector('.edit-btn').addEventListener('click', () => editItem(item));
          tr.querySelector('.delete-btn').addEventListener('click', () => deleteItem(item.id));
        });
      }

      function updateStats(items) {
        const total = items.length;
        const totalValue = items.reduce((sum, it) => sum + ((it.total || 0) - (it.used || 0)), 0);
        const lowStock = items.filter(it => it.total > 0 && ((it.total - it.used) / it.total) < 0.15).length;

        document.getElementById('statTotalMaterials').textContent = total;
        document.getElementById('statTotalValue').textContent = totalValue.toFixed(2);
        document.getElementById('statLowStock').textContent = lowStock;
        document.getElementById('statLastUpdate').textContent = new Date().toLocaleTimeString();
      }

      function editItem(item) {
        const tr = document.querySelector(`tr[data-id="${item.id}"]`);
        tr.innerHTML = `
          <td><input class="form-control form-control-sm edit-name" value="${escapeHtml(item.name)}"></td>
          <td><input class="form-control form-control-sm edit-unit" value="${escapeHtml(item.unit || '')}"></td>
          <td><input type="number" step="0.01" class="form-control form-control-sm edit-total" value="${item.total}"></td>
          <td><input type="number" step="0.01" class="form-control form-control-sm edit-used" value="${item.used}"></td>
          <td>-</td>
          <td>-</td>
          <td>
            <button class="btn btn-sm btn-success save-btn">Save</button>
            <button class="btn btn-sm btn-secondary cancel-btn">Cancel</button>
          </td>
        `;

        tr.querySelector('.save-btn').addEventListener('click', () => saveItem(item.id, tr));
        tr.querySelector('.cancel-btn').addEventListener('click', refreshInventory);
      }

      async function saveItem(id, tr) {
        const payload = {
          name: tr.querySelector('.edit-name').value,
          unit: tr.querySelector('.edit-unit').value,
          total: parseFloat(tr.querySelector('.edit-total').value) || 0,
          used: parseFloat(tr.querySelector('.edit-used').value) || 0,
        };

        try {
          const res = await fetch(`${inventoryApiBase}/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload),
          });
          if(!res.ok) throw new Error('Failed to save');
          refreshInventory();
        } catch(err) {
          alert('Failed to save changes');
          console.error(err);
        }
      }

      async function deleteItem(id) {
        if(!confirm('Delete this material?')) return;
        
        try {
          const res = await fetch(`${inventoryApiBase}/${id}`, { method: 'DELETE' });
          if(!res.ok) throw new Error('Failed to delete');
          refreshInventory();
        } catch(err) {
          alert('Failed to delete material');
          console.error(err);
        }
      }

      // Add new material
      document.getElementById('addItemBtn').addEventListener('click', async function() {
        const name = document.getElementById('newName').value.trim();
        const unit = document.getElementById('newUnit').value;
        const total = parseFloat(document.getElementById('newTotal').value) || 0;
        const used = parseFloat(document.getElementById('newUsed').value) || 0;

        if(!name) {
          alert('Please enter material name');
          return;
        }

        try {
          const res = await fetch(inventoryApiBase, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name, unit, total, used }),
          });
          if(!res.ok) throw new Error('Failed to add');
          
          bootstrap.Modal.getInstance(document.getElementById('addMaterialModal')).hide();
          document.getElementById('newName').value = '';
          document.getElementById('newTotal').value = '0';
          document.getElementById('newUsed').value = '0';
          refreshInventory();
        } catch(err) {
          alert('Failed to add material');
          console.error(err);
        }
      });

      // Search button
      document.getElementById('filterSearchBtn').addEventListener('click', refreshInventory);

      // Initial load
      refreshInventory();

      // NOTE: Auto-refresh REMOVED - use manual refresh to avoid UI interference
    </script>
  </body>
</html>