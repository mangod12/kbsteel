<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>KumarBrothers ‚Äî Production Tracking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/main.css" rel="stylesheet">
    <style>
      .checklist-item { display: flex; align-items: center; gap: 8px; padding: 4px 0; }
      .checklist-item input[type="checkbox"] { width: 18px; height: 18px; }
      .checklist-done { text-decoration: line-through; color: #6c757d; }
      .edit-modal-field { margin-bottom: 12px; }
      .stage-badge { font-size: 0.75rem; padding: 4px 8px; }
      .action-btn { padding: 2px 8px; font-size: 0.75rem; }
      .deducted-badge { font-size: 0.65rem; }
    </style>
  </head>
  <body>
    <nav class="kb-navbar d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <div class="navbar-brand">KumarBrothers</div>
          <div class="d-none d-lg-flex">
          <a class="nav-link text-white ms-3" href="index.html">Dashboard</a>
          <a class="nav-link text-white ms-3" href="raw_material.html">Inventory</a>
          <a class="nav-link text-white ms-3" href="customers.html">Customers</a>
          <a class="nav-link text-white ms-3" href="queries.html">Queries</a>
          <a class="nav-link text-white ms-3" href="instructions.html">Instructions</a>
          <a class="nav-link text-white ms-3 kb-logout" href="#">Logout</a>
        </div>
      </div>
      <div class="d-flex align-items-center gap-3">
        <div class="small-muted">Role:</div>
        <div id="current-role" class="role-badge">Loading...</div>
      </div>
    </nav>

    <div class="container-fluid main-container">
      <!-- Page Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="fw-bold mb-0">Production Tracking</h2>
          <small class="text-muted">Track materials across Fabrication ‚Üí Painting ‚Üí Dispatch</small>
        </div>
        <div class="d-flex gap-2">
          <div class="dropdown">
            <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              üì§ Upload Stage Excel
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" onclick="openStageUploadModal('fabrication')">üîß Fabrication Excel</a></li>
              <li><a class="dropdown-item" href="#" onclick="openStageUploadModal('painting')">üé® Painting Excel</a></li>
              <li><a class="dropdown-item" href="#" onclick="openStageUploadModal('dispatch')">üöö Dispatch Excel</a></li>
            </ul>
          </div>
          <button class="btn btn-success" onclick="location.reload()">üîÑ Refresh</button>
        </div>
      </div>

      <!-- Advanced Search & Filters -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
          <div class="row g-3 align-items-end">

            <div class="col-md-3">
              <label class="form-label">Search Item</label>
              <input type="text" class="form-control" id="searchItem" placeholder="Item name / Code / Section">
            </div>

            <div class="col-md-2">
              <label class="form-label">Customer</label>
              <input type="text" class="form-control" id="searchCustomer" placeholder="Customer name">
            </div>

            <div class="col-md-2">
              <label class="form-label">Stage</label>
              <select class="form-select" id="filterStage">
                <option value="">All</option>
                <option value="Fabrication">Fabrication</option>
                <option value="Painting">Painting</option>
                <option value="Dispatch">Dispatch</option>
              </select>
            </div>

            <div class="col-md-2">
              <label class="form-label">Stage Status</label>
              <select class="form-select" id="filterStatus">
                <option value="">All</option>
                <option value="pending">Pending</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
              </select>
            </div>

            <div class="col-md-1">
              <label class="form-label">Min Qty</label>
              <input type="number" class="form-control" id="minQty">
            </div>

            <div class="col-md-1">
              <label class="form-label">Max Qty</label>
              <input type="number" class="form-control" id="maxQty">
            </div>

            <div class="col-md-1 d-grid">
              <button class="btn btn-primary" id="applyTrackingBtn" type="button">Search</button>
            </div>

          </div>
        </div>
      </div>

      <!-- Stage-Wise Tracking Table -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
          <h5 class="fw-semibold mb-3">Tracking Details</h5>

          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-light">
                <tr>
                  <th>Customer</th>
                  <th>Item</th>
                  <th>Section</th>
                  <th>Qty</th>
                  <th>Fabrication</th>
                  <th>Painting</th>
                  <th>Dispatch</th>
                  <th>Checklist</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="trackingTableBody">
                <!-- Rows will be rendered by page script -->
              </tbody>
            </table>
          </div>

        </div>
      </div>

      <!-- Empty / No Results State -->
      <div class="text-center text-muted py-4 d-none" id="noTrackingResults">No tracking records found for the selected filters.</div>

    </div>

    <!-- Edit Item Modal -->
    <div class="modal fade" id="editItemModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Tracking Item</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editItemId">
            <div class="row">
              <div class="col-md-6">
                <div class="edit-modal-field">
                  <label class="form-label">Item Code</label>
                  <input type="text" class="form-control" id="editItemCode">
                </div>
                <div class="edit-modal-field">
                  <label class="form-label">Item Name</label>
                  <input type="text" class="form-control" id="editItemName">
                </div>
                <div class="edit-modal-field">
                  <label class="form-label">Section</label>
                  <input type="text" class="form-control" id="editSection">
                </div>
                <div class="edit-modal-field">
                  <label class="form-label">Length (mm)</label>
                  <input type="number" class="form-control" id="editLength">
                </div>
              </div>
              <div class="col-md-6">
                <div class="edit-modal-field">
                  <label class="form-label">Quantity</label>
                  <input type="number" step="0.01" class="form-control" id="editQuantity">
                </div>
                <div class="edit-modal-field">
                  <label class="form-label">Unit</label>
                  <input type="text" class="form-control" id="editUnit">
                </div>
                <div class="edit-modal-field">
                  <label class="form-label">Weight per Unit</label>
                  <input type="number" step="0.01" class="form-control" id="editWeight">
                </div>
                <div class="edit-modal-field">
                  <label class="form-label">Notes</label>
                  <textarea class="form-control" id="editNotes" rows="2"></textarea>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" id="saveEditBtn">Save Changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Checklist Modal -->
    <div class="modal fade" id="checklistModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Item Checklist</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="checklistItemId">
            <div id="checklistItems"></div>
            <div class="mt-3">
              <div class="input-group">
                <input type="text" class="form-control" id="newChecklistItem" placeholder="Add new checklist item">
                <button class="btn btn-outline-primary" id="addChecklistBtn">Add</button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="saveChecklistBtn">Save Checklist</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Stage Excel Upload Modal -->
    <div class="modal fade" id="stageUploadModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <span id="stageUploadIcon">üì§</span> Upload <span id="stageUploadTitle">Stage</span> Excel
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="uploadStageType">
            
            <div class="alert alert-info">
              <strong>üìã Instructions:</strong>
              <ul class="mb-0 mt-2">
                <li>Upload .xlsx or .csv file with tracking data for the selected stage</li>
                <li>System matches items by <strong>Drawing No</strong>, <strong>Item Code</strong>, <strong>Assembly</strong>, or <strong>Item Name</strong></li>
                <li>Supported columns: Drawing no, Assembly, Name, Profile, Qty, WT-(kg), AR(m¬≤), Paint, Date, Lot, Status, Remarks</li>
                <li>Status values: "Completed", "In Progress", "Pending" (or Yes/No/Done/WIP)</li>
              </ul>
            </div>
            
            <div class="mb-3">
              <label class="form-label fw-bold">Select Excel/CSV File</label>
              <input type="file" class="form-control" id="stageExcelFile" accept=".xlsx,.csv">
            </div>
            
            <div id="stagePreviewArea" class="d-none">
              <h6 class="fw-bold mb-2">üìä Preview (First 10 rows)</h6>
              <div class="alert alert-success py-2">
                <strong>Detected Columns:</strong> <span id="detectedColumns"></span>
              </div>
              <div id="stagePreviewContent" class="table-responsive" style="max-height: 350px; overflow-y: auto;"></div>
              <div class="mt-2 d-flex justify-content-between align-items-center">
                <small class="text-muted">Total rows: <span id="totalRowCount">0</span></small>
                <small class="text-muted">Items will be matched by Drawing No/Item Code/Assembly/Name and updated</small>
              </div>
            </div>
            
            <div id="stageUploadStatus" class="mt-3"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-warning" id="previewStageBtn">üëÅÔ∏è Preview</button>
            <button type="button" class="btn btn-primary" id="importStageBtn" disabled>‚úÖ Import & Update</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/main.js"></script>
    <script>
      (function(){
        const API_BASE = (typeof KBConfig !== 'undefined') ? KBConfig.API_BASE : 'http://127.0.0.1:8000';
        const apiBase = `${API_BASE}/tracking/all-items`;
        const btn = document.getElementById('applyTrackingBtn');
        const tbody = document.getElementById('trackingTableBody');
        const emptyEl = document.getElementById('noTrackingResults');
        
        let currentItems = [];
        let currentChecklist = [];

        function buildParams(){
          const p = new URLSearchParams();
          const item = document.getElementById('searchItem').value.trim();
          const customer = document.getElementById('searchCustomer').value.trim();
          const stage = document.getElementById('filterStage').value;
          const status = document.getElementById('filterStatus').value;
          const minQty = document.getElementById('minQty').value;
          const maxQty = document.getElementById('maxQty').value;

          if(item) p.append('search', item);
          if(stage) p.append('stage', stage);
          if(status) p.append('status', status);

          return p.toString();
        }

        async function applyTrackingFilters(){
          try{
            const qs = buildParams();
            const url = qs ? `${apiBase}?${qs}` : apiBase;
            const res = await fetch(url);
            if(!res.ok) throw new Error('Fetch failed');
            const data = await res.json();
            currentItems = data || [];
            
            // Filter by customer name on frontend (case-insensitive)
            const customerFilter = document.getElementById('searchCustomer').value.trim().toLowerCase();
            let filtered = currentItems;
            if(customerFilter) {
              filtered = currentItems.filter(it => 
                (it.customer_name || '').toLowerCase().includes(customerFilter)
              );
            }
            
            renderTracking(filtered);
          }catch(err){
            console.error('Tracking fetch error', err);
            renderTracking([]);
          }
        }

        function renderTracking(items){
          tbody.innerHTML = '';
          if(!items || items.length === 0){
            emptyEl.classList.remove('d-none');
            return;
          }
          emptyEl.classList.add('d-none');

          items.forEach(it => {
            const tr = document.createElement('tr');
            const qty = it.quantity || 1;
            const fab = statusBadge(it.fabrication_status);
            const paint = statusBadge(it.painting_status);
            const disp = statusBadge(it.dispatch_status);
            
            // Checklist progress
            let checklistProgress = '0/0';
            let checklist = it.checklist || [];
            if(checklist.length > 0) {
              const done = checklist.filter(c => c.done).length;
              checklistProgress = `${done}/${checklist.length}`;
            }
            
            // Deduction badge
            const deductedBadge = it.fabrication_deducted 
              ? '<span class="badge bg-info deducted-badge ms-1" title="Materials deducted">‚úì Deducted</span>' 
              : '';

            tr.innerHTML = `
              <td>${escapeHtml(it.customer_name || '')}</td>
              <td>${escapeHtml(it.item_name || '')} <small class="text-muted">(${escapeHtml(it.item_code || '')})</small></td>
              <td>${escapeHtml(it.section || '-')}</td>
              <td>${escapeHtml(String(qty))} ${escapeHtml(it.unit || '')}</td>
              <td>${fab}${it.current_stage === 'Fabrication' ? deductedBadge : ''}</td>
              <td>${paint}</td>
              <td>${disp}</td>
              <td>
                <button class="btn btn-sm btn-outline-secondary action-btn" onclick="openChecklist(${it.id})">
                  üìã ${checklistProgress}
                </button>
              </td>
              <td>
                <button class="btn btn-sm btn-outline-primary action-btn" onclick="openEditModal(${it.id})">‚úèÔ∏è Edit</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        }

        function statusBadge(s){
          if(!s) return `<span class="badge bg-secondary stage-badge">N/A</span>`;
          const st = String(s).toLowerCase();
          if(st.includes('compl') || st === 'completed') return `<span class="badge bg-success stage-badge">Completed</span>`;
          if(st.includes('in') || st.includes('progress')) return `<span class="badge bg-warning text-dark stage-badge">In Progress</span>`;
          if(st.includes('pend')) return `<span class="badge bg-secondary stage-badge">Pending</span>`;
          return `<span class="badge bg-secondary stage-badge">${escapeHtml(s)}</span>`;
        }

        function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

        // Edit Modal Functions
        window.openEditModal = async function(itemId) {
          try {
            const res = await fetch(`${API_BASE}/tracking/items/${itemId}`);
            if(!res.ok) throw new Error('Failed to load item');
            const item = await res.json();
            
            document.getElementById('editItemId').value = item.id;
            document.getElementById('editItemCode').value = item.item_code || '';
            document.getElementById('editItemName').value = item.item_name || '';
            document.getElementById('editSection').value = item.section || '';
            document.getElementById('editLength').value = item.length_mm || '';
            document.getElementById('editQuantity').value = item.quantity || 1;
            document.getElementById('editUnit').value = item.unit || '';
            document.getElementById('editWeight').value = item.weight_per_unit || '';
            document.getElementById('editNotes').value = item.notes || '';
            
            new bootstrap.Modal(document.getElementById('editItemModal')).show();
          } catch(err) {
            alert('Failed to load item details');
            console.error(err);
          }
        };

        document.getElementById('saveEditBtn').addEventListener('click', async function() {
          const itemId = document.getElementById('editItemId').value;
          const payload = {
            item_code: document.getElementById('editItemCode').value,
            item_name: document.getElementById('editItemName').value,
            section: document.getElementById('editSection').value || null,
            length_mm: parseInt(document.getElementById('editLength').value) || null,
            quantity: parseFloat(document.getElementById('editQuantity').value) || 1,
            unit: document.getElementById('editUnit').value || null,
            weight_per_unit: parseFloat(document.getElementById('editWeight').value) || null,
            notes: document.getElementById('editNotes').value || null,
          };
          
          try {
            const res = await fetch(`${API_BASE}/tracking/items/${itemId}`, {
              method: 'PUT',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(payload),
            });
            if(!res.ok) throw new Error('Failed to save');
            
            bootstrap.Modal.getInstance(document.getElementById('editItemModal')).hide();
            applyTrackingFilters(); // Refresh
          } catch(err) {
            alert('Failed to save changes');
            console.error(err);
          }
        });

        // Checklist Functions
        window.openChecklist = async function(itemId) {
          try {
            const res = await fetch(`${API_BASE}/tracking/items/${itemId}`);
            if(!res.ok) throw new Error('Failed to load item');
            const item = await res.json();
            
            document.getElementById('checklistItemId').value = item.id;
            currentChecklist = item.checklist ? JSON.parse(item.checklist) : [];
            renderChecklist();
            
            new bootstrap.Modal(document.getElementById('checklistModal')).show();
          } catch(err) {
            alert('Failed to load checklist');
            console.error(err);
          }
        };

        function renderChecklist() {
          const container = document.getElementById('checklistItems');
          container.innerHTML = '';
          
          if(currentChecklist.length === 0) {
            container.innerHTML = '<p class="text-muted">No checklist items. Add one below.</p>';
            return;
          }
          
          currentChecklist.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'checklist-item';
            div.innerHTML = `
              <input type="checkbox" ${item.done ? 'checked' : ''} onchange="toggleChecklistItem(${idx})">
              <span class="${item.done ? 'checklist-done' : ''}">${escapeHtml(item.item)}</span>
              <button class="btn btn-sm btn-outline-danger" onclick="removeChecklistItem(${idx})">√ó</button>
            `;
            container.appendChild(div);
          });
        }

        window.toggleChecklistItem = function(idx) {
          currentChecklist[idx].done = !currentChecklist[idx].done;
          renderChecklist();
        };

        window.removeChecklistItem = function(idx) {
          currentChecklist.splice(idx, 1);
          renderChecklist();
        };

        document.getElementById('addChecklistBtn').addEventListener('click', function() {
          const input = document.getElementById('newChecklistItem');
          const text = input.value.trim();
          if(!text) return;
          
          currentChecklist.push({ item: text, done: false });
          input.value = '';
          renderChecklist();
        });

        document.getElementById('saveChecklistBtn').addEventListener('click', async function() {
          const itemId = document.getElementById('checklistItemId').value;
          
          try {
            const res = await fetch(`${API_BASE}/tracking/items/${itemId}/checklist`, {
              method: 'PUT',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(currentChecklist),
            });
            if(!res.ok) throw new Error('Failed to save');
            
            bootstrap.Modal.getInstance(document.getElementById('checklistModal')).hide();
            applyTrackingFilters(); // Refresh
          } catch(err) {
            alert('Failed to save checklist');
            console.error(err);
          }
        });

        // Attach handler
        if(btn) btn.addEventListener('click', applyTrackingFilters);

        // Allow pressing Enter in inputs to trigger search
        ['searchItem','searchCustomer'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); applyTrackingFilters(); } }); });

        // Initial load
        applyTrackingFilters();

        // NOTE: Auto-refresh REMOVED - use manual refresh to avoid UI interference

        // ============ Stage Excel Upload Functions ============
        const stageIcons = { fabrication: 'üîß', painting: 'üé®', dispatch: 'üöö' };
        const stageColors = { fabrication: 'primary', painting: 'warning', dispatch: 'success' };
        
        window.openStageUploadModal = function(stage) {
          document.getElementById('uploadStageType').value = stage;
          document.getElementById('stageUploadTitle').textContent = stage.charAt(0).toUpperCase() + stage.slice(1);
          document.getElementById('stageUploadIcon').textContent = stageIcons[stage] || 'üì§';
          document.getElementById('stageExcelFile').value = '';
          document.getElementById('stagePreviewArea').classList.add('d-none');
          document.getElementById('stageUploadStatus').innerHTML = '';
          document.getElementById('importStageBtn').disabled = true;
          
          new bootstrap.Modal(document.getElementById('stageUploadModal')).show();
        };

        // Preview Stage Excel
        document.getElementById('previewStageBtn').addEventListener('click', async function() {
          const stage = document.getElementById('uploadStageType').value;
          const fileInput = document.getElementById('stageExcelFile');
          const statusEl = document.getElementById('stageUploadStatus');
          
          if(!fileInput.files || !fileInput.files[0]) {
            statusEl.innerHTML = '<div class="alert alert-danger">Please select an Excel file first</div>';
            return;
          }
          
          const file = fileInput.files[0];
          if(!file.name.toLowerCase().endsWith('.xlsx')) {
            statusEl.innerHTML = '<div class="alert alert-danger">Only .xlsx files are supported</div>';
            return;
          }
          
          statusEl.innerHTML = '<div class="alert alert-info">Loading preview...</div>';
          
          const formData = new FormData();
          formData.append('file', file);
          
          try {
            const res = await fetch(`${API_BASE}/excel/preview-stage/${stage}`, {
              method: 'POST',
              body: formData,
            });
            
            const data = await res.json();
            
            if(!res.ok) {
              statusEl.innerHTML = `<div class="alert alert-danger">${data.detail || 'Preview failed'}</div>`;
              return;
            }
            
            // Show preview
            document.getElementById('stagePreviewArea').classList.remove('d-none');
            document.getElementById('detectedColumns').textContent = Object.keys(data.detected_mapping || {}).join(', ') || 'None detected';
            document.getElementById('totalRowCount').textContent = data.row_count || 0;
            
            // Build preview table
            const previewContent = document.getElementById('stagePreviewContent');
            if(data.preview_rows && data.preview_rows.length > 0) {
              const cols = data.columns || [];
              let html = '<table class="table table-sm table-bordered"><thead class="table-light"><tr>';
              cols.forEach(col => {
                const mapped = data.detected_mapping && data.detected_mapping[col] ? ` ‚Üí ${data.detected_mapping[col]}` : '';
                html += `<th>${escapeHtml(col)}${mapped ? `<br><small class="text-success">${mapped}</small>` : ''}</th>`;
              });
              html += '</tr></thead><tbody>';
              
              data.preview_rows.forEach(row => {
                html += '<tr>';
                cols.forEach(col => {
                  html += `<td>${escapeHtml(String(row[col] || ''))}</td>`;
                });
                html += '</tr>';
              });
              
              html += '</tbody></table>';
              previewContent.innerHTML = html;
            } else {
              previewContent.innerHTML = '<p class="text-muted">No rows to preview</p>';
            }
            
            statusEl.innerHTML = `<div class="alert alert-success">${data.instructions || 'Ready to import!'}</div>`;
            document.getElementById('importStageBtn').disabled = false;
            
          } catch(err) {
            statusEl.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
          }
        });

        // Import Stage Excel
        document.getElementById('importStageBtn').addEventListener('click', async function() {
          const stage = document.getElementById('uploadStageType').value;
          const fileInput = document.getElementById('stageExcelFile');
          const statusEl = document.getElementById('stageUploadStatus');
          const btn = this;
          
          if(!fileInput.files || !fileInput.files[0]) {
            statusEl.innerHTML = '<div class="alert alert-danger">Please select an Excel file first</div>';
            return;
          }
          
          btn.disabled = true;
          btn.textContent = '‚è≥ Importing...';
          statusEl.innerHTML = '<div class="alert alert-info">Processing Excel file...</div>';
          
          const formData = new FormData();
          formData.append('file', fileInput.files[0]);
          
          try {
            const res = await fetch(`${API_BASE}/excel/upload-stage/${stage}`, {
              method: 'POST',
              body: formData,
            });
            
            const data = await res.json();
            
            if(!res.ok) {
              statusEl.innerHTML = `<div class="alert alert-danger">${data.detail || 'Import failed'}</div>`;
              btn.disabled = false;
              btn.textContent = '‚úÖ Import & Update';
              return;
            }
            
            let resultHtml = `<div class="alert alert-success">
              <strong>‚úÖ ${data.message}</strong><br>
              <small>Items updated: ${data.items_updated}</small>
            </div>`;
            
            if(data.items_not_found && data.items_not_found.length > 0) {
              resultHtml += `<div class="alert alert-warning">
                <strong>‚ö†Ô∏è Items not found (${data.items_not_found.length}):</strong><br>
                <small>${data.items_not_found.slice(0, 5).join(', ')}${data.items_not_found.length > 5 ? '...' : ''}</small>
              </div>`;
            }
            
            if(data.errors && data.errors.length > 0) {
              resultHtml += `<div class="alert alert-danger">
                <strong>‚ùå Errors:</strong><br>
                <small>${data.errors.slice(0, 3).join('<br>')}</small>
              </div>`;
            }
            
            statusEl.innerHTML = resultHtml;
            
            // Refresh tracking table
            setTimeout(() => {
              applyTrackingFilters();
              bootstrap.Modal.getInstance(document.getElementById('stageUploadModal')).hide();
            }, 2000);
            
          } catch(err) {
            statusEl.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
          } finally {
            btn.disabled = false;
            btn.textContent = '‚úÖ Import & Update';
          }
        });

      })();
    </script>
  </body>
</html>