<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>KumarBrothers ‚Äî Production Tracking</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="css/main.css" rel="stylesheet">
  <style>
    /* Kanban Board Styles */
    .kanban-board { display: flex; gap: 16px; min-height: calc(100vh - 300px); }
    .kanban-column { flex: 1; min-width: 300px; background: #f8f9fa; border-radius: 8px; padding: 12px; }
    .kanban-column-header { 
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 12px; border-radius: 6px; margin-bottom: 12px; color: white; font-weight: 600;
    }
    .fabrication-header { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .painting-header { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .dispatch-header { background: linear-gradient(135deg, #10b981, #059669); }
    .completed-header { background: linear-gradient(135deg, #6b7280, #4b5563); }
    
    .kanban-cards { max-height: calc(100vh - 380px); overflow-y: auto; }
    
    .tracking-card {
      background: white; border-radius: 8px; padding: 12px; margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid #e5e7eb;
      transition: all 0.2s ease;
    }
    .tracking-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-2px); }
    .tracking-card.fabrication { border-left-color: #f59e0b; }
    .tracking-card.painting { border-left-color: #3b82f6; }
    .tracking-card.dispatch { border-left-color: #10b981; }
    .tracking-card.completed { border-left-color: #6b7280; }
    
    .card-title { font-weight: 600; font-size: 0.9rem; color: #1f2937; margin-bottom: 4px; }
    .card-code { font-size: 0.75rem; color: #6b7280; }
    .card-meta { font-size: 0.75rem; color: #9ca3af; margin-top: 6px; }
    
    /* Inline Checklist */
    .checklist-inline { margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; }
    .checklist-item { 
      display: flex; align-items: center; gap: 6px; padding: 3px 0;
      font-size: 0.8rem; cursor: pointer;
    }
    .checklist-item input[type="checkbox"] { width: 14px; height: 14px; cursor: pointer; }
    .checklist-item.done label { text-decoration: line-through; color: #9ca3af; }
    .checklist-add { 
      display: flex; gap: 4px; margin-top: 6px;
    }
    .checklist-add input { 
      flex: 1; padding: 4px 8px; font-size: 0.75rem; 
      border: 1px solid #d1d5db; border-radius: 4px;
    }
    .checklist-add button { 
      padding: 4px 8px; font-size: 0.7rem; 
      background: #e5e7eb; border: none; border-radius: 4px; cursor: pointer;
    }
    
    /* Action Button */
    .complete-btn {
      width: 100%; margin-top: 10px; padding: 8px 12px;
      font-size: 0.8rem; font-weight: 500; border: none; border-radius: 6px;
      cursor: pointer; transition: all 0.2s;
    }
    .complete-btn.fabrication { background: #fef3c7; color: #92400e; }
    .complete-btn.fabrication:hover { background: #fde68a; }
    .complete-btn.painting { background: #dbeafe; color: #1e40af; }
    .complete-btn.painting:hover { background: #bfdbfe; }
    .complete-btn.dispatch { background: #d1fae5; color: #065f46; }
    .complete-btn.dispatch:hover { background: #a7f3d0; }
    .complete-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* Material Deduction Badge */
    .deducted-badge { 
      display: inline-block; padding: 2px 6px; font-size: 0.65rem;
      background: #dbeafe; color: #1e40af; border-radius: 4px; margin-left: 6px;
    }
    
    /* Search & Filter Bar */
    .filter-bar { 
      background: white; border-radius: 8px; padding: 16px; margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    /* Summary Stats */
    .stage-stats { display: flex; gap: 12px; margin-bottom: 16px; }
    .stat-pill {
      padding: 6px 16px; border-radius: 20px; font-size: 0.85rem; font-weight: 500;
    }
    .stat-pill.fabrication { background: #fef3c7; color: #92400e; }
    .stat-pill.painting { background: #dbeafe; color: #1e40af; }
    .stat-pill.dispatch { background: #d1fae5; color: #065f46; }
    .stat-pill.completed { background: #f3f4f6; color: #4b5563; }
    
    /* Toast Notification */
    .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; }
    
    /* Last Updated */
    .last-updated { font-size: 0.75rem; color: #9ca3af; }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.8); display: none;
      justify-content: center; align-items: center; z-index: 9998;
    }
    .loading-overlay.show { display: flex; }
  </style>
</head>
<body>
  <nav class="kb-navbar d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-3">
      <div class="navbar-brand">KumarBrothers</div>
      <div class="d-none d-lg-flex">
        <a class="nav-link text-white ms-3" href="index.html">Dashboard</a>
        <a class="nav-link text-white ms-3" href="raw_material.html">Inventory</a>
        <a class="nav-link text-white ms-3" href="scrap.html">Scrap</a>
        <a class="nav-link text-white ms-3" href="reusable.html">Reusable</a>
        <a class="nav-link text-white ms-3" href="customers.html">Customers</a>
        <a class="nav-link text-white ms-3 active" href="tracking_v2.html">Tracking</a>
        <a class="nav-link text-white ms-3" href="settings.html">Settings</a>
        <a class="nav-link text-white ms-3 kb-logout" href="#">Logout</a>
      </div>
    </div>
    <div class="d-flex align-items-center gap-3">
      <div class="small-muted">Role:</div>
      <div id="current-role" class="role-badge">Loading...</div>
    </div>
  </nav>

  <div class="container-fluid main-container">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="fw-bold mb-0">Production Tracking</h2>
        <small class="text-muted">Fabrication ‚Üí Painting ‚Üí Dispatch</small>
      </div>
      <div class="d-flex align-items-center gap-3">
        <span class="last-updated">Last updated: <span id="lastUpdate">-</span></span>
        <button class="btn btn-outline-primary btn-sm" onclick="loadTrackingData()">üîÑ Refresh</button>
      </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
      <div class="row g-3 align-items-end">
        <div class="col-md-4">
          <label class="form-label small">Search</label>
          <input type="text" class="form-control" id="searchInput" placeholder="Item name, code, customer, section...">
        </div>
        <div class="col-md-2">
          <label class="form-label small">Customer</label>
          <select class="form-select" id="filterCustomer">
            <option value="">All Customers</option>
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label small">View</label>
          <select class="form-select" id="viewMode">
            <option value="kanban">Kanban Board</option>
            <option value="table">Table View</option>
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" onclick="applyFilters()">üîç Search</button>
        </div>
        <div class="col-md-2">
          <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">Clear</button>
        </div>
      </div>
    </div>

    <!-- Stage Stats Summary -->
    <div class="stage-stats">
      <span class="stat-pill fabrication">üîß Fabrication: <span id="countFab">0</span></span>
      <span class="stat-pill painting">üé® Painting: <span id="countPaint">0</span></span>
      <span class="stat-pill dispatch">üöö Dispatch: <span id="countDispatch">0</span></span>
      <span class="stat-pill completed">‚úÖ Completed: <span id="countComplete">0</span></span>
    </div>

    <!-- Kanban Board View -->
    <div id="kanbanView" class="kanban-board">
      <div class="kanban-column">
        <div class="kanban-column-header fabrication-header">
          <span>üîß Fabrication</span>
          <span class="badge bg-white text-dark" id="fabCount">0</span>
        </div>
        <div class="kanban-cards" id="fabCards"></div>
      </div>
      
      <div class="kanban-column">
        <div class="kanban-column-header painting-header">
          <span>üé® Painting</span>
          <span class="badge bg-white text-dark" id="paintCount">0</span>
        </div>
        <div class="kanban-cards" id="paintCards"></div>
      </div>
      
      <div class="kanban-column">
        <div class="kanban-column-header dispatch-header">
          <span>üöö Dispatch</span>
          <span class="badge bg-white text-dark" id="dispatchCount">0</span>
        </div>
        <div class="kanban-cards" id="dispatchCards"></div>
      </div>
      
      <div class="kanban-column">
        <div class="kanban-column-header completed-header">
          <span>‚úÖ Completed</span>
          <span class="badge bg-white text-dark" id="completeCount">0</span>
        </div>
        <div class="kanban-cards" id="completeCards"></div>
      </div>
    </div>

    <!-- Table View (Hidden by default) -->
    <div id="tableView" class="card" style="display: none;">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Customer</th>
              <th>Item</th>
              <th>Section</th>
              <th>Qty</th>
              <th>Stage</th>
              <th>Checklist</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Material Deduction Preview Modal -->
  <div class="modal fade" id="deductionModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title">‚ö†Ô∏è Confirm Material Deduction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Completing <strong>Fabrication</strong> will automatically deduct raw materials from inventory:</p>
          <div id="deductionPreview" class="alert alert-info"></div>
          <p class="text-muted small mb-0">This action cannot be undone. Materials will be deducted immediately.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-warning" id="confirmDeductionBtn">Complete & Deduct</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/config.js"></script>
  <script src="js/main.js"></script>
  <script>
    const API_BASE = (typeof KBConfig !== 'undefined') ? KBConfig.API_BASE : 'http://127.0.0.1:8000';
    
    let allItems = [];
    let filteredItems = [];
    let customers = [];
    let pendingDeductionItem = null;

    // ===== Utility Functions =====
    function escapeHtml(s) { 
      return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); 
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `alert alert-${type} alert-dismissible fade show`;
      toast.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
      document.getElementById('toastContainer').appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }

    function showLoading(show) {
      document.getElementById('loadingOverlay').classList.toggle('show', show);
    }

    // ===== Data Loading =====
    async function loadTrackingData() {
      showLoading(true);
      try {
        const res = await fetch(`${API_BASE}/tracking/all-items`);
        if (!res.ok) throw new Error('Failed to load tracking data');
        allItems = await res.json();
        
        // Also load customers for filter dropdown
        const custRes = await fetch(`${API_BASE}/tracking/customers`);
        if (custRes.ok) {
          customers = await custRes.json();
          populateCustomerFilter();
        }
        
        applyFilters();
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
      } catch (err) {
        console.error('Load error:', err);
        showToast('Failed to load tracking data', 'danger');
      } finally {
        showLoading(false);
      }
    }

    function populateCustomerFilter() {
      const select = document.getElementById('filterCustomer');
      select.innerHTML = '<option value="">All Customers</option>';
      const uniqueCustomers = [...new Set(allItems.map(it => it.customer_name))].filter(Boolean).sort();
      uniqueCustomers.forEach(name => {
        select.innerHTML += `<option value="${escapeHtml(name)}">${escapeHtml(name)}</option>`;
      });
    }

    function applyFilters() {
      const search = document.getElementById('searchInput').value.toLowerCase().trim();
      const customer = document.getElementById('filterCustomer').value;
      
      filteredItems = allItems.filter(item => {
        if (customer && item.customer_name !== customer) return false;
        if (search) {
          const searchIn = [item.item_name, item.item_code, item.customer_name, item.section].join(' ').toLowerCase();
          if (!searchIn.includes(search)) return false;
        }
        return true;
      });
      
      renderView();
    }

    function clearFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('filterCustomer').value = '';
      applyFilters();
    }

    // ===== Rendering =====
    function renderView() {
      const viewMode = document.getElementById('viewMode').value;
      document.getElementById('kanbanView').style.display = viewMode === 'kanban' ? 'flex' : 'none';
      document.getElementById('tableView').style.display = viewMode === 'table' ? 'block' : 'none';
      
      if (viewMode === 'kanban') {
        renderKanban();
      } else {
        renderTable();
      }
      
      updateStats();
    }

    function updateStats() {
      const fab = filteredItems.filter(it => getStage(it) === 'fabrication').length;
      const paint = filteredItems.filter(it => getStage(it) === 'painting').length;
      const dispatch = filteredItems.filter(it => getStage(it) === 'dispatch').length;
      const complete = filteredItems.filter(it => getStage(it) === 'completed').length;
      
      document.getElementById('countFab').textContent = fab;
      document.getElementById('countPaint').textContent = paint;
      document.getElementById('countDispatch').textContent = dispatch;
      document.getElementById('countComplete').textContent = complete;
      
      document.getElementById('fabCount').textContent = fab;
      document.getElementById('paintCount').textContent = paint;
      document.getElementById('dispatchCount').textContent = dispatch;
      document.getElementById('completeCount').textContent = complete;
    }

    function getStage(item) {
      // Determine current stage from status fields
      if (item.dispatch_status === 'completed') return 'completed';
      if (item.dispatch_status === 'in_progress' || item.painting_status === 'completed') return 'dispatch';
      if (item.painting_status === 'in_progress' || item.fabrication_status === 'completed') return 'painting';
      return 'fabrication';
    }

    function getNextStage(currentStage) {
      const flow = { fabrication: 'painting', painting: 'dispatch', dispatch: 'completed' };
      return flow[currentStage] || null;
    }

    function renderKanban() {
      const containers = {
        fabrication: document.getElementById('fabCards'),
        painting: document.getElementById('paintCards'),
        dispatch: document.getElementById('dispatchCards'),
        completed: document.getElementById('completeCards')
      };
      
      // Clear all
      Object.values(containers).forEach(c => c.innerHTML = '');
      
      // Sort and distribute items
      filteredItems.forEach(item => {
        const stage = getStage(item);
        const card = createTrackingCard(item, stage);
        if (containers[stage]) {
          containers[stage].appendChild(card);
        }
      });
      
      // Show empty state if no items
      Object.entries(containers).forEach(([stage, container]) => {
        if (container.children.length === 0) {
          container.innerHTML = '<div class="text-muted text-center py-4 small">No items</div>';
        }
      });
    }

    function createTrackingCard(item, stage) {
      const card = document.createElement('div');
      card.className = `tracking-card ${stage}`;
      card.dataset.itemId = item.id;
      
      const checklist = item.checklist || [];
      const checklistDone = checklist.filter(c => c.done).length;
      const checklistTotal = checklist.length;
      
      const nextStage = getNextStage(stage);
      const showCompleteBtn = stage !== 'completed';
      
      const deductedBadge = item.fabrication_deducted 
        ? '<span class="deducted-badge">‚úì Deducted</span>' 
        : '';
      
      card.innerHTML = `
        <div class="card-title">${escapeHtml(item.item_name)} ${stage === 'fabrication' ? deductedBadge : ''}</div>
        <div class="card-code">${escapeHtml(item.item_code)} ‚Ä¢ ${escapeHtml(item.customer_name)}</div>
        <div class="card-meta">
          ${item.section ? `Section: ${escapeHtml(item.section)} ‚Ä¢ ` : ''}
          Qty: ${item.quantity || 1} ${escapeHtml(item.unit || '')}
        </div>
        
        <div class="checklist-inline" id="checklist-${item.id}">
          ${checklist.map((c, idx) => `
            <div class="checklist-item ${c.done ? 'done' : ''}" onclick="toggleChecklistItem(${item.id}, ${idx})">
              <input type="checkbox" ${c.done ? 'checked' : ''} onclick="event.stopPropagation(); toggleChecklistItem(${item.id}, ${idx})">
              <label>${escapeHtml(c.item)}</label>
            </div>
          `).join('')}
          <div class="checklist-add">
            <input type="text" placeholder="Add checklist item..." id="newCheck-${item.id}" onkeypress="if(event.key==='Enter') addChecklistItem(${item.id})">
            <button onclick="addChecklistItem(${item.id})">+</button>
          </div>
        </div>
        
        ${showCompleteBtn ? `
          <button class="complete-btn ${stage}" onclick="completeStage(${item.id}, '${stage}')">
            ‚úì Complete ${stage.charAt(0).toUpperCase() + stage.slice(1)}
          </button>
        ` : '<div class="text-center mt-2 text-success small">‚úÖ Fully Completed</div>'}
      `;
      
      return card;
    }

    function renderTable() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';
      
      filteredItems.forEach(item => {
        const stage = getStage(item);
        const checklist = item.checklist || [];
        const checklistDone = checklist.filter(c => c.done).length;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(item.customer_name)}</td>
          <td>
            <strong>${escapeHtml(item.item_name)}</strong>
            <br><small class="text-muted">${escapeHtml(item.item_code)}</small>
          </td>
          <td>${escapeHtml(item.section || '-')}</td>
          <td>${item.quantity || 1} ${escapeHtml(item.unit || '')}</td>
          <td><span class="badge bg-${getStageBadgeColor(stage)}">${stage.charAt(0).toUpperCase() + stage.slice(1)}</span></td>
          <td>${checklistDone}/${checklist.length}</td>
          <td>
            ${stage !== 'completed' ? `
              <button class="btn btn-sm btn-outline-success" onclick="completeStage(${item.id}, '${stage}')">
                Complete
              </button>
            ` : '‚úÖ'}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function getStageBadgeColor(stage) {
      return { fabrication: 'warning', painting: 'info', dispatch: 'success', completed: 'secondary' }[stage] || 'secondary';
    }

    // ===== Checklist Operations =====
    async function toggleChecklistItem(itemId, index) {
      const item = allItems.find(it => it.id === itemId);
      if (!item) return;
      
      const checklist = item.checklist || [];
      if (checklist[index]) {
        checklist[index].done = !checklist[index].done;
      }
      
      try {
        await fetch(`${API_BASE}/tracking/items/${itemId}/checklist`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(checklist)
        });
        
        // Update local state and re-render card
        item.checklist = checklist;
        const card = document.querySelector(`[data-item-id="${itemId}"]`);
        if (card) {
          const stage = getStage(item);
          const newCard = createTrackingCard(item, stage);
          card.replaceWith(newCard);
        }
      } catch (err) {
        console.error('Checklist update failed:', err);
        showToast('Failed to update checklist', 'danger');
      }
    }

    async function addChecklistItem(itemId) {
      const input = document.getElementById(`newCheck-${itemId}`);
      const text = input.value.trim();
      if (!text) return;
      
      const item = allItems.find(it => it.id === itemId);
      if (!item) return;
      
      const checklist = item.checklist || [];
      checklist.push({ item: text, done: false });
      
      try {
        await fetch(`${API_BASE}/tracking/items/${itemId}/checklist`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(checklist)
        });
        
        item.checklist = checklist;
        input.value = '';
        
        // Re-render card
        const card = document.querySelector(`[data-item-id="${itemId}"]`);
        if (card) {
          const stage = getStage(item);
          const newCard = createTrackingCard(item, stage);
          card.replaceWith(newCard);
        }
      } catch (err) {
        console.error('Add checklist failed:', err);
        showToast('Failed to add checklist item', 'danger');
      }
    }

    // ===== Stage Completion =====
    async function completeStage(itemId, currentStage) {
      const item = allItems.find(it => it.id === itemId);
      if (!item) return;
      
      // If completing fabrication, show deduction preview first
      if (currentStage === 'fabrication' && !item.fabrication_deducted) {
        showDeductionPreview(item);
        return;
      }
      
      await performStageCompletion(itemId, currentStage);
    }

    function showDeductionPreview(item) {
      pendingDeductionItem = item;
      
      let previewHtml = '';
      if (item.material_requirements) {
        try {
          const reqs = JSON.parse(item.material_requirements);
          previewHtml = '<ul class="mb-0">';
          reqs.forEach(r => {
            previewHtml += `<li><strong>${escapeHtml(r.inventory_name || r.profile)}</strong>: ${r.qty.toFixed(2)} kg</li>`;
          });
          previewHtml += '</ul>';
        } catch {
          previewHtml = '<p class="mb-0">Material requirements linked - will be deducted automatically.</p>';
        }
      } else {
        previewHtml = '<p class="mb-0 text-warning">‚ö†Ô∏è No material requirements linked. No deduction will occur.</p>';
      }
      
      document.getElementById('deductionPreview').innerHTML = previewHtml;
      new bootstrap.Modal(document.getElementById('deductionModal')).show();
    }

    document.getElementById('confirmDeductionBtn').addEventListener('click', async () => {
      if (!pendingDeductionItem) return;
      
      bootstrap.Modal.getInstance(document.getElementById('deductionModal')).hide();
      await performStageCompletion(pendingDeductionItem.id, 'fabrication');
      pendingDeductionItem = null;
    });

    async function performStageCompletion(itemId, currentStage) {
      showLoading(true);
      
      try {
        // Start stage if not already started
        await fetch(`${API_BASE}/tracking/start-stage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ production_item_id: itemId, stage: currentStage })
        });
        
        // Complete stage
        const res = await fetch(`${API_BASE}/tracking/complete-stage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ production_item_id: itemId, stage: currentStage })
        });
        
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.detail || 'Failed to complete stage');
        }
        
        const nextStage = getNextStage(currentStage);
        showToast(`‚úÖ ${currentStage.charAt(0).toUpperCase() + currentStage.slice(1)} completed! ${currentStage === 'fabrication' ? 'Materials deducted.' : ''}`);
        
        // Reload data
        await loadTrackingData();
        
      } catch (err) {
        console.error('Stage completion error:', err);
        showToast(err.message, 'danger');
      } finally {
        showLoading(false);
      }
    }

    // ===== View Mode Change =====
    document.getElementById('viewMode').addEventListener('change', renderView);
    
    // ===== Search on Enter =====
    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') applyFilters();
    });

    // ===== Initial Load =====
    loadTrackingData();
  </script>
</body>
</html>
